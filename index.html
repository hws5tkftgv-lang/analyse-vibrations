<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport"
content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>Poulies & courroie ‚Äî simulation</title>

<style>
:root{
  --bg:#0b1436;
  --panel:#101a40;
  --text:#eaf1ff;
  --muted:rgba(234,241,255,.65);
  --blue:#00a2ff;
  --orange:#ff9800;
  --belt:#9a9a9a;
}
*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html,body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Arial,system-ui,sans-serif;
}

header{
  padding:10px 14px;
  font-size:16px;
  font-weight:700;
}

.controls{
  padding:10px 14px;
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:8px;
}

.controls label{
  font-size:12px;
  color:var(--muted);
}

.controls input, .controls select{
  width:100%;
  padding:7px 9px;
  font-size:14px;
  border-radius:8px;
  border:none;
  outline:none;
}

.controls .full{ grid-column:1 / -1; }

.buttons{
  display:flex;
  gap:10px;
  padding:0 14px 10px;
}

button{
  flex:1;
  padding:10px;
  font-size:15px;
  border:none;
  border-radius:10px;
  background:#1c2b6a;
  color:white;
}

.stage{
  padding:10px 14px;
}

canvas{
  width:100%;
  background:#000;
  border-radius:12px;
  display:block;
}

.results{
  padding:10px 14px 18px;
  font-size:14px;
  line-height:1.45;
}

.smallMuted{ color:var(--muted); font-size:12px; }

.dot{
  display:inline-block;width:10px;height:10px;border-radius:50%;
  margin-right:6px;vertical-align:-1px;
}
.blue{background:var(--blue);}
.orange{background:var(--orange);}
.white{background:#fff;}

.sliderWrap{
  display:flex;
  align-items:center;
  gap:10px;
}
#slow{ flex:1; }
#slowVal{ min-width:56px; text-align:right; font-size:12px; color:var(--muted); }
</style>
</head>

<body>
<header>üîÑ Poulies & courroie ‚Äî simulation</header>

<div class="controls">
  <label>RPM moteur
    <input id="rpm" type="number" placeholder="ex: 1500">
  </label>

  <label>Unit√©s
    <select id="unit">
      <option value="imperial" selected>po</option>
      <option value="metric">mm</option>
    </select>
  </label>

  <label>√ò menante
    <input id="d1" type="number" placeholder="ex: 4">
  </label>

  <label>√ò men√©e
    <input id="d2" type="number" placeholder="ex: 9">
  </label>

  <label class="full">C-C
    <input id="cc" type="number" placeholder="ex: 21">
  </label>

  <div class="full">
    <div class="smallMuted">Ralenti animation</div>
    <div class="sliderWrap">
      <input id="slow" type="range" min="0.25" max="4" step="0.25" value="1">
      <div id="slowVal">√ó1.00</div>
    </div>
  </div>
</div>

<div class="buttons">
  <button id="play">‚ñ∂Ô∏è Play</button>
  <button id="pause">‚è∏ Pause</button>
  <button id="reset">üîÑ Reset</button>
</div>

<div class="stage">
  <canvas id="scene"></canvas>
</div>

<div class="results" id="info"></div>

<script>
(() => {
  const canvas = document.getElementById("scene");
  const ctx = canvas.getContext("2d");

  const rpmEl  = document.getElementById("rpm");
  const d1El   = document.getElementById("d1");
  const d2El   = document.getElementById("d2");
  const ccEl   = document.getElementById("cc");
  const unitEl = document.getElementById("unit");
  const infoEl = document.getElementById("info");

  const playBtn  = document.getElementById("play");
  const pauseBtn = document.getElementById("pause");
  const resetBtn = document.getElementById("reset");

  const slowEl  = document.getElementById("slow");
  const slowVal = document.getElementById("slowVal");

  const TAU = Math.PI * 2;
  const IN_TO_MM = 25.4;
  const BASE_TIME_SCALE = 0.10;

  let t = 0;
  let running = false;
  let lastTS = null;
  let lockedWidth = null;

  function lerp(p, q, u){
    return { x:p.x+(q.x-p.x)*u, y:p.y+(q.y-p.y)*u };
  }

  function resize(){
    if(lockedWidth===null){
      lockedWidth = Math.min(window.innerWidth-24,720);
    }
    const w = lockedWidth;
    const h = w*0.6;
    const dpr = Math.min(3,window.devicePixelRatio||1);
    canvas.style.width=w+"px";
    canvas.style.height=h+"px";
    canvas.width=w*dpr;
    canvas.height=h*dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize",resize);
  resize();

  function readInputsMM(){
    let rpm=+rpmEl.value, d1=+d1El.value, d2=+d2El.value, cc=+ccEl.value;
    if(!rpm||!d1||!d2||!cc) return null;
    if(unitEl.value==="imperial"){
      d1*=IN_TO_MM; d2*=IN_TO_MM; cc*=IN_TO_MM;
    }
    return {rpm,d1mm:d1,d2mm:d2,ccmm:cc};
  }

  function resetAll(){
    running=false; t=0;
    rpmEl.value=d1El.value=d2El.value=ccEl.value="";
    slowEl.value=1; slowVal.textContent="√ó1.00";
    draw();
  }

  playBtn.onclick=()=>{ if(readInputsMM()) running=true; };
  pauseBtn.onclick=()=>running=false;
  resetBtn.onclick=resetAll;

  slowEl.oninput=()=>slowVal.textContent="√ó"+(+slowEl.value).toFixed(2);

  function loop(ts){
    if(!lastTS) lastTS=ts;
    const dt=(ts-lastTS)/1000;
    lastTS=ts;
    if(running) t+=dt*BASE_TIME_SCALE/(+slowEl.value||1);
    draw();
    requestAnimationFrame(loop);
  }

  function draw(){
    const W=parseFloat(canvas.style.width);
    const H=parseFloat(canvas.style.height);
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle="#000";
    ctx.fillRect(0,0,W,H);

    const inp=readInputsMM();
    if(!inp){
      infoEl.innerHTML=`<div class="smallMuted">En pause ‚Äî entre les donn√©es puis ‚ñ∂Ô∏è Play</div>`;
      return;
    }

    const {rpm,d1mm,d2mm,ccmm}=inp;
    const r1mm=d1mm/2, r2mm=d2mm/2;

    const v_mm_s = rpm*Math.PI*d1mm/60;
    const s_mm = v_mm_s*t;

    const ang1 = -(s_mm/r1mm);
    const ang2 = -(s_mm/r2mm);

    const margin=40;
    const Cmm=Math.max(ccmm,Math.abs(r2mm-r1mm)+1e-6);
    const scale=Math.min(
      (W-2*margin)/(Cmm+r1mm+r2mm),
      (H-2*margin)/(2*Math.max(r1mm,r2mm))
    );

    const r1=r1mm*scale, r2=r2mm*scale, C=Cmm*scale;
    const x1=margin+r1, x2=x1+C, y=H/2;

    const phi=Math.acos(Math.max(-1,Math.min(1,(r2-r1)/C)));

    const aL_top=phi,aL_bot=-phi;
    const aR_top=Math.PI-phi,aR_bot=Math.PI+phi;

    const Ltop={x:x1+r1*Math.cos(aL_top),y:y+r1*Math.sin(aL_top)};
    const Lbot={x:x1+r1*Math.cos(aL_bot),y:y+r1*Math.sin(aL_bot)};
    const Rtop={x:x2+r2*Math.cos(aR_top),y:y+r2*Math.sin(aR_top)};
    const Rbot={x:x2+r2*Math.cos(aR_bot),y:y+r2*Math.sin(aR_bot)};

    ctx.strokeStyle= "#9a9a9a";
    ctx.lineWidth=4;
    ctx.beginPath();
    ctx.moveTo(Ltop.x,Ltop.y);
    ctx.lineTo(Rtop.x,Rtop.y);
    ctx.arc(x2,y,r2,aR_top,aR_bot,false);
    ctx.lineTo(Lbot.x,Lbot.y);
    ctx.arc(x1,y,r1,aL_bot,aL_top,false);
    ctx.stroke();

    function pulley(cx,cy,r,col,a){
      ctx.strokeStyle=col; ctx.lineWidth=3;
      ctx.beginPath(); ctx.arc(cx,cy,r,0,TAU); ctx.stroke();
      ctx.fillStyle=col;
      ctx.beginPath();
      ctx.arc(cx+(r-6)*Math.cos(a),cy+(r-6)*Math.sin(a),6,0,TAU);
      ctx.fill();
    }
    pulley(x1,y,r1,"#00a2ff",ang1);
    pulley(x2,y,r2,"#ff9800",ang2);

    const lenTop=Math.hypot(Rtop.x-Ltop.x,Rtop.y-Ltop.y);
    const lenBot=Math.hypot(Lbot.x-Rbot.x,Lbot.y-Rbot.y);
    const arcSmall=r1*(2*phi);
    const arcBig=r2*(TAU-2*phi);
    const beltLen_px=lenTop+arcBig+lenBot+arcSmall;

    let sPos=(s_mm*scale)%beltLen_px, P;
    if(sPos<=lenTop) P=lerp(Ltop,Rtop,sPos/lenTop);
    else if((sPos-=lenTop)<=arcBig){
      const a=aR_top-(sPos/arcBig)*(TAU-2*phi);
      P={x:x2+r2*Math.cos(a),y:y+r2*Math.sin(a)};
    } else if((sPos-=arcBig)<=lenBot){
      P=lerp(Rbot,Lbot,sPos/lenBot);
    } else {
      sPos-=lenBot;
      const a=aL_bot+(sPos/arcSmall)*(aL_top-aL_bot);
      P={x:x1+r1*Math.cos(a),y:y+r1*Math.sin(a)};
    }

    ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.arc(P.x,P.y,5,0,TAU);
    ctx.fill();

    const beltHz = v_mm_s / ((2*Math.sqrt(Cmm*Cmm-(r2mm-r1mm)**2))+(r1mm*(2*phi))+(r2mm*(TAU-2*phi)));
    const beltCPM=beltHz*60;

    infoEl.innerHTML=`
      <div><span class="dot blue"></span><b>Poulie menante</b> :
        ${rpm.toFixed(0)} RPM | ${(rpm/60).toFixed(2)} Hz</div>
      <div><span class="dot orange"></span><b>Poulie men√©e</b> :
        ${(rpm*(d1mm/d2mm)).toFixed(0)} RPM</div>
      <div><span class="dot white"></span><b>Courroie</b> :
        ${(unitEl.value==="imperial"
          ? (rpm*Math.PI*(d1mm/IN_TO_MM)/12).toFixed(2)+" pi/min"
          : v_mm_s.toFixed(1)+" mm/s")}
        <br>${beltHz.toFixed(2)} Hz | ${beltCPM.toFixed(0)} CPM
      </div>
    `;
  }

  resetAll();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>