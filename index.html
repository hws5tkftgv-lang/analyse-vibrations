<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport"
content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>Poulies & courroie ‚Äî simulation</title>

<style>
:root{
  --bg:#0b1436;
  --panel:#101a40;
  --text:#eaf1ff;
  --muted:rgba(234,241,255,.65);
  --blue:#00a2ff;
  --orange:#ff9800;
  --belt:#9a9a9a;
}
*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html,body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Arial,system-ui,sans-serif;
}

header{
  padding:10px 14px;
  font-size:16px;
  font-weight:700;
  display:flex;
  align-items:center;
  gap:8px;
}

.controls{
  padding:10px 14px;
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:8px;
}

.controls label{
  font-size:12px;
  color:var(--muted);
}

.controls input, .controls select{
  width:100%;
  padding:7px 9px;
  font-size:14px;
  border-radius:8px;
  border:none;
  outline:none;
}

.controls .full{ grid-column:1 / -1; }

.buttons{
  display:flex;
  gap:10px;
  padding:0 14px 10px;
}

button{
  flex:1;
  padding:10px;
  font-size:15px;
  border:none;
  border-radius:10px;
  background:#1c2b6a;
  color:white;
}

.stage{
  padding:10px 14px;
}

canvas{
  width:100%;
  background:#000;
  border-radius:12px;
  display:block;
}

.results{
  padding:10px 14px 18px;
  font-size:14px;
  line-height:1.45;
  color:var(--text);
}

.smallMuted{ color:var(--muted); font-size:12px; }

.dot{
  display:inline-block;width:10px;height:10px;border-radius:50%;
  margin-right:6px;vertical-align:-1px;
}
.blue{background:var(--blue);}
.orange{background:var(--orange);}
.white{background:#fff;}

.rowLine{ margin-top:6px; }

.sliderWrap{
  display:flex;
  align-items:center;
  gap:10px;
}
#slow{ flex:1; }
#slowVal{ min-width:56px; text-align:right; font-size:12px; color:var(--muted); }
</style>
</head>

<body>
<header>üîÑ Poulies & courroie ‚Äî simulation</header>

<div class="controls">
  <label>RPM moteur
    <input id="rpm" type="number" inputmode="decimal" placeholder="ex: 1500">
  </label>

  <label>Unit√©s
    <select id="unit">
      <option value="imperial" selected>po</option>
      <option value="metric">mm</option>
    </select>
  </label>

  <label>√ò menante
    <input id="d1" type="number" inputmode="decimal" placeholder="ex: 4">
  </label>

  <label>√ò men√©e
    <input id="d2" type="number" inputmode="decimal" placeholder="ex: 9">
  </label>

  <label class="full">C-C
    <input id="cc" type="number" inputmode="decimal" placeholder="ex: 21">
  </label>

  <div class="full">
    <div class="smallMuted">Ralenti animation</div>
    <div class="sliderWrap">
      <input id="slow" type="range" min="0.25" max="4" step="0.25" value="1">
      <div id="slowVal">√ó1.00</div>
    </div>
  </div>
</div>

<div class="buttons">
  <button id="play">‚ñ∂Ô∏è Play</button>
  <button id="pause">‚è∏ Pause</button>
  <button id="reset">üîÑ Reset</button>
</div>

<div class="stage">
  <canvas id="scene"></canvas>
</div>

<div class="results" id="info"></div>

<script>
(() => {
  const canvas = document.getElementById("scene");
  const ctx = canvas.getContext("2d");

  const rpmEl  = document.getElementById("rpm");
  const d1El   = document.getElementById("d1");
  const d2El   = document.getElementById("d2");
  const ccEl   = document.getElementById("cc");
  const unitEl = document.getElementById("unit");
  const infoEl = document.getElementById("info");

  const playBtn  = document.getElementById("play");
  const pauseBtn = document.getElementById("pause");
  const resetBtn = document.getElementById("reset");

  const slowEl  = document.getElementById("slow");
  const slowVal = document.getElementById("slowVal");

  const TAU = Math.PI * 2;
  const IN_TO_MM = 25.4;

  // ‚úÖ ralenti global (par d√©faut) -> plus lent ET coh√©rent
  // 0.10 = 10% de la vitesse "r√©elle"
  const BASE_TIME_SCALE = 0.10;

  let t = 0;              // temps "simulation"
  let running = false;    // pause par d√©faut
  let lastTS = null;
  let lockedWidth = null;

  function lerp(p, q, u){
    return { x: p.x + (q.x - p.x)*u, y: p.y + (q.y - p.y)*u };
  }

  // arc long (pour la grande poulie)
  function arcLong(cx, cy, r, start, end){
    // si l‚Äôarc direct (sens horaire) est court, on force l‚Äôautre
    let s = start % TAU; if(s < 0) s += TAU;
    let e = end % TAU;   if(e < 0) e += TAU;
    let delta = e - s;
    if(delta < 0) delta += TAU;      // delta dans [0, 2œÄ)
    const anticlockwise = (delta <= Math.PI); // si c‚Äôest le court -> on prend l‚Äôautre sens
    ctx.arc(cx, cy, r, start, end, anticlockwise);
  }

  function resize(){
    if(lockedWidth === null){
      lockedWidth = Math.min(window.innerWidth - 24, 720);
    }
    const w = lockedWidth;
    const h = w * 0.60;
    const dpr = Math.min(3, window.devicePixelRatio || 1);

    canvas.style.width  = w + "px";
    canvas.style.height = h + "px";
    canvas.width  = Math.round(w * dpr);
    canvas.height = Math.round(h * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener("resize", resize);
  resize();

  function setInfo(html){ infoEl.innerHTML = html; }

  function readInputsMM(){
    // champs vides -> NaN
    const rpm = parseFloat(rpmEl.value);
    let d1 = parseFloat(d1El.value);
    let d2 = parseFloat(d2El.value);
    let cc = parseFloat(ccEl.value);

    if(!isFinite(rpm) || !isFinite(d1) || !isFinite(d2) || !isFinite(cc)) {
      return null;
    }
    if(rpm <= 0 || d1 <= 0 || d2 <= 0 || cc <= 0) {
      return null;
    }

    // en mm interne
    if(unitEl.value === "imperial"){
      d1 *= IN_TO_MM;
      d2 *= IN_TO_MM;
      cc *= IN_TO_MM;
    }
    return { rpm, d1mm:d1, d2mm:d2, ccmm:cc };
  }

  function resetAll(){
    running = false;
    t = 0;
    rpmEl.value = "";
    d1El.value = "";
    d2El.value = "";
    ccEl.value = "";
    slowEl.value = 1;
    slowVal.textContent = "√ó1.00";
    draw(); // affiche √©tat initial
  }

  function tryPlay(){
    const inp = readInputsMM();
    if(!inp){
      running = false;
      draw();
      setInfo(`
        <div class="smallMuted">‚õî Entre RPM, √ò menante, √ò men√©e et C-C (valeurs > 0), puis ‚ñ∂Ô∏è Play.</div>
      `);
      return;
    }
    running = true;
  }

  // boutons (pointerup = fiable iOS)
  playBtn.addEventListener("pointerup", tryPlay);
  pauseBtn.addEventListener("pointerup", () => running = false);
  resetBtn.addEventListener("pointerup", resetAll);

  slowEl.addEventListener("input", () => {
    slowVal.textContent = "√ó" + parseFloat(slowEl.value).toFixed(2);
  });

  function loop(ts){
    if(lastTS === null) lastTS = ts;
    const dt = (ts - lastTS) / 1000;
    lastTS = ts;

    if(running){
      const slow = parseFloat(slowEl.value) || 1;
      // ‚úÖ ralenti global + slider
      t += dt * BASE_TIME_SCALE / slow;
    }
    draw();
    requestAnimationFrame(loop);
  }

  function draw(){
    const W = parseFloat(canvas.style.width);
    const H = parseFloat(canvas.style.height);

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,W,H);

    const inp = readInputsMM();
    if(!inp){
      // √©cran + infos neutres
      setInfo(`
        <div class="rowLine"><span class="dot blue"></span><b>Poulie menante</b> : ‚Äî</div>
        <div class="rowLine"><span class="dot orange"></span><b>Poulie men√©e</b> : ‚Äî</div>
        <div class="rowLine"><span class="dot white"></span><b>Courroie</b> : ‚Äî</div>
        <div class="smallMuted" style="margin-top:8px;">(En pause. Remplis les champs, puis ‚ñ∂Ô∏è Play.)</div>
      `);
      return;
    }

    const { rpm, d1mm, d2mm, ccmm } = inp;

    // vitesses rotation
    const f1 = rpm / 60;
    const rpm2 = rpm * (d1mm / d2mm);
    const f2 = rpm2 / 60;

    const w1 = TAU * f1;
    const w2 = TAU * f2;

    const ang1 = -w1 * t;
    const ang2 = -w2 * t;

    // g√©om√©trie (en mm)
    const r1mm = d1mm / 2;
    const r2mm = d2mm / 2;
    const minCC = Math.abs(r2mm - r1mm) + 1e-6;
    const Cmm = Math.max(ccmm, minCC);

    // scale
    const margin = 40;
    const s = Math.min(
      (W - 2*margin) / (Cmm + r1mm + r2mm),
      (H - 2*margin) / (2 * Math.max(r1mm, r2mm))
    );

    const r1 = r1mm * s;
    const r2 = r2mm * s;
    const C  = Cmm  * s;

    const x1 = margin + r1;
    const x2 = x1 + C;
    const y  = H / 2;

    // phi = acos((R-r)/C) avec R = r2, r = r1
    const ratio = Math.max(-1, Math.min(1, (r2 - r1) / C));
    const phi = Math.acos(ratio);

    // tangences (angles)
    const aL_top = +phi, aL_bot = -phi;               // petite poulie (droite)
    const aR_top = Math.PI - phi, aR_bot = Math.PI + phi; // grande poulie (gauche)

    const Ltop = {x: x1 + r1*Math.cos(aL_top), y: y + r1*Math.sin(aL_top)};
    const Lbot = {x: x1 + r1*Math.cos(aL_bot), y: y + r1*Math.sin(aL_bot)};
    const Rtop = {x: x2 + r2*Math.cos(aR_top), y: y + r2*Math.sin(aR_top)};
    const Rbot = {x: x2 + r2*Math.cos(aR_bot), y: y + r2*Math.sin(aR_bot)};

    // === COURROIE (petite = arc court, grande = arc long) ===
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--belt') || "#9a9a9a";
    ctx.lineWidth = 4;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.beginPath();
    ctx.moveTo(Ltop.x, Ltop.y);
    ctx.lineTo(Rtop.x, Rtop.y);

    // grande poulie: arc long
    arcLong(x2, y, r2, aR_top, aR_bot);

    ctx.lineTo(Lbot.x, Lbot.y);

    // petite poulie: arc court (de -phi √† +phi)
    ctx.arc(x1, y, r1, aL_bot, aL_top, false);

    ctx.stroke();

    // === POULIES ===
    function drawPulley(cx, cy, r, col, a){
      ctx.strokeStyle = col;
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, TAU);
      ctx.stroke();

      ctx.fillStyle = col;
      ctx.beginPath();
      ctx.arc(cx + (r-6)*Math.cos(a), cy + (r-6)*Math.sin(a), 6, 0, TAU);
      ctx.fill();
    }
    drawPulley(x1, y, r1, "#00a2ff", ang1);
    drawPulley(x2, y, r2, "#ff9800", ang2);

    // === POINT SUR COURROIE (avance avec vitesse lin√©aire) ===
    // vitesse lin√©aire "√©cran" en px/s (bas√©e sur menante)
    const v_px_s = Math.abs(w1) * r1;

    // longueurs (√©cran)
    const lenTop = Math.hypot(Rtop.x - Ltop.x, Rtop.y - Ltop.y);
    const lenBot = Math.hypot(Lbot.x - Rbot.x, Lbot.y - Rbot.y);

    const arcSmall = r1 * (2*phi);                  // petite poulie (court)
    const arcBig   = r2 * (TAU - 2*phi);            // grande poulie (long)

    const beltLen_px = lenTop + arcBig + lenBot + arcSmall;

    let sPos = (v_px_s * t) % beltLen_px;
    let P;

    if(sPos <= lenTop){
      P = lerp(Ltop, Rtop, sPos / lenTop);
    } else if((sPos -= lenTop) <= arcBig){
      // arc long grande poulie : param√®tre u sur [0,1]
      const u = sPos / arcBig;
      // on parcourt l‚Äôangle long (sens choisi dans arcLong) -> utiliser m√™me logique :
      // angle long = TAU - 2phi
      const a = aR_top - u*(TAU - 2*phi);
      P = { x: x2 + r2*Math.cos(a), y: y + r2*Math.sin(a) };
    } else if((sPos -= arcBig) <= lenBot){
      P = lerp(Rbot, Lbot, sPos / lenBot);
    } else {
      sPos -= lenBot;
      const u = sPos / arcSmall;
      // petite poulie arc court de -phi √† +phi
      const a = aL_top - u * (aL_top - aL_bot);
      P = {
  x: x1 + r1 * Math.cos(a),
  y: y + r1 * Math.sin(a)
  };
    }

    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(P.x, P.y, 5, 0, TAU);
    ctx.fill();

    // === VITESSE LIN√âAIRE (physique) + fr√©quence courroie v/L ===
    const v_mm_s = (rpm * Math.PI * d1mm) / 60;     // mm/s
    const v_in_min = rpm * Math.PI * (d1mm/IN_TO_MM); // in/min
    const v_ft_min = v_in_min / 12;                 // ft/min

    // longueur courroie (physique) en mm :
    // spans = sqrt(C^2 - (R-r)^2)
    const span = Math.sqrt(Math.max(0, Cmm*Cmm - (r2mm - r1mm)*(r2mm - r1mm)));
    const beltLen_mm = (2*span) + (r1mm * (2*phi)) + (r2mm * (TAU - 2*phi));

    // fr√©quence courroie (Hz) = v / L
    const beltHz = (beltLen_mm > 0) ? (v_mm_s / beltLen_mm) : 0;
    const beltCPM = beltHz * 60;

    // format vitesse
    const beltSpeedStr = (unitEl.value === "imperial")
      ? `${v_ft_min.toFixed(2)} pi/min`
      : `${v_mm_s.toFixed(1)} mm/s`;

    setInfo(`
      <div class="rowLine"><span class="dot blue"></span><b>Poulie menante</b> :
        ${rpm.toFixed(0)} RPM | ${f1.toFixed(2)} Hz | ${(f1*60).toFixed(0)} CPM
      </div>

      <div class="rowLine"><span class="dot orange"></span><b>Poulie men√©e</b> :
        ${rpm2.toFixed(0)} RPM | ${f2.toFixed(2)} Hz | ${(f2*60).toFixed(0)} CPM
      </div>

      <div class="rowLine"><span class="dot white"></span><b>Courroie (lin√©aire)</b> :
        ${beltSpeedStr}<br>
        ${beltHz.toFixed(2)} Hz | ${beltCPM.toFixed(0)} CPM
      </div>

      <div class="smallMuted" style="margin-top:8px;">
        ${running ? "‚ñ∂Ô∏è En lecture" : "‚è∏ En pause"}
      </div>
    `);
  }

  // init : afficher √©tat initial (pause + champs vides)
  resetAll();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>